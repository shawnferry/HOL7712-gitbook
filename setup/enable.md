# Enabling Puppet on Solaris

So far we have only executed puppet against a local manifest to bootstrap the lab environment. Given that the title of the lab '_Oracle Solaris Administration with Puppet'_ when can we get to some actual administration?

We are almost there but first we need to do a few more configration steps. It is possible to do all the remaining configuration via puppet manifests but we will use Solaris commands for some of the steps instead.

![](/images/SETUP-008.0-svccfg-svcadm.png)

## Wait what's SMF and why can't I edit this file?

## Configure Puppet Master Server
$$
PUP-9
$$

1. > svccfg -s puppet:master setprop config/server=puppet

  Change the config/server property to set the name of the puppet server. In this lab everyone should be able to use the server called 'puppet'. In your environment you would want to use the FQDN of your puppet master.

## Configure Puppet Agent Server
$$
PUP-10
$$

1. > svccfg -s puppet:agent setprop config/server=puppet

  Change the config/server property to set the name of the puppet server. In this lab everyone should be able to use the server called 'puppet'. In your environment you would want to use the FQDN of your puppet master.

## Refresh Master and Agent config
$$
PUP-11
$$

1. > svcadm refresh puppet:master puppet:agent

  In the previous steps we changed the configuration we need to refresh the services for those changes to take effect.

## Enable puppet:master and puppet:agent
$$
PUP-12
$$

1. > svcadm enable puppet:master puppet:agent

  This starts both the master and agent daemons and writes the puppet.conf file with the configuration data stored in SMF

  ![](/images/SETUP-008.1-puppet-conf.png)

  As stated at the top of the file; this file is generated by SMF. Do not make manual changes to this file.

## Mark the puppet:agent state to maintenance
$$
PUP-13
$$

1. > svcadm mark maintenance puppet:agent

  Placing puppet:agent into maintenance state stops the puppet agent daemon from running and prevents later errors about puppet already running while we manually run the agent.

## Check the state of the puppet:agent service
$$
PUP-14
$$

1. > svcs puppet:agent

  ![](/images/SETUP-008.2-maintenance.png)

## Run the puppet agent
$$
PUP-16
$$

1. > puppet agent --test

  ![](/images/SETUP-008.3-agent--test.png)

  We haven't written any manifests at this time. Without a manifest defined we are simply testing the connection to the master.

  ### Wait, aren't we the master?

  Yes, the server called puppet-N is the master in the configuration. However, by default puppet uses a FQDN or a couple of well known aliases for the puppet server certificate. At this point in the configuration the puppet master cannot verify the identity of the agent  and the agent is unable to verify the identity of the server.

## Finding the problem
$$
PUP-23
$$

1. > puppet resource host

  Wait, what just happened? Almost all puppet providers know how to gather the state of an existing resource. Some will show you all the resources of that type, some will only show you the resource you pass on the command line. **Hint:** You can use this to output a valid puppet resource.

2. Among other names we are expecting the puppet server to be called 'puppet', that name is not present in the current set of host resources.

  ## ![](/images/SETUP-008.4-resource-host.png)Fixing the problem
$$
PUP-24
$$

1. > puppet resource host -e \`hostname\`

  Do as I say not as I screenshot. You are executing puppet resource host -e &lt;the name of your system&gt;. The -e option to puppet resource allows you to edit a resource or resources immediately after querying the configuration.![](/images/SETUP-008.5-resource-host-e.png)

2. Write and quit the buffer. If the contents are unacceptable you can delete the whole of the contents and try again.

3. After writing the file puppet will execute the change as if you wrote a manifest snippet and applied it.

  ![](/images/SETUP-008.6-resource-host-after.png)

## View the host resources again
$$
PUP-25
$$

1. > puppet resource host

  Note the entry in host\_aliases for puppet which was just added.

##  Test the agent connection again
$$
PUP-43
$$

1. I'm aware that the numbers aren't monotonically increasing.

2. We still see warnings because we have not written any manifests for the nodes but the connection is successful.

  ![](/images/SETUP-008.7-puppet-agent-test.png)

  ![](/images/SETUP-008.8-puppet-agent-test-cont.png)

3. Why are there all these changes if there are no manifests to drive changes?

  The puppet agent automatically downloads all of the plugins on the master at the start of each run. Generally that means you will only see this the first time and agent talks to the server and after any plugin is updated on the server.

This completes the basic configuration of the puppet server in this lab.

